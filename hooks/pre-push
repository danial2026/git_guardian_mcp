#!/usr/bin/env bash
#
# Git pre-push hook
# Runs complete validation: static analysis + tests on unpushed commits
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Find git-guardian-mcp binary
GIT_GUARDIAN=""
if [ -f "$(git rev-parse --show-toplevel)/git-guardian-mcp" ]; then
    GIT_GUARDIAN="$(git rev-parse --show-toplevel)/git-guardian-mcp"
elif command -v git-guardian-mcp &> /dev/null; then
    GIT_GUARDIAN="git-guardian-mcp"
else
    echo -e "${RED}Error: git-guardian-mcp not found${NC}"
    echo "Please build the binary: go build -o git-guardian-mcp"
    exit 1
fi

REPO_PATH=$(git rev-parse --show-toplevel)
CONFIG_PATH="$REPO_PATH/.mcp.yml"

# Read stdin to get remote and branch info
while read local_ref local_sha remote_ref remote_sha
do
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        # Deleting a branch, skip checks
        continue
    fi

    # Extract branch name from ref
    BRANCH=$(echo "$remote_ref" | sed 's/refs\/heads\///')
    REMOTE=$(git config --get "branch.$BRANCH.remote" || echo "origin")

    echo -e "${BLUE}Validating push to $REMOTE/$BRANCH...${NC}"

    # Create temporary files for MCP communication
    TMP_REQUEST=$(mktemp)
    TMP_RESPONSE=$(mktemp)

    # Build MCP request for full validation
    cat > "$TMP_REQUEST" << EOF
{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"validate_push","arguments":{"repo_path":"$REPO_PATH","remote":"$REMOTE","branch":"$BRANCH","config_path":"$CONFIG_PATH"}}}
EOF

    # Call MCP server
    if ! "$GIT_GUARDIAN" < "$TMP_REQUEST" > "$TMP_RESPONSE" 2>&1; then
        echo -e "${RED}Failed to run validation${NC}"
        cat "$TMP_RESPONSE"
        rm -f "$TMP_REQUEST" "$TMP_RESPONSE"
        exit 1
    fi

    # Parse response
    RESPONSE=$(cat "$TMP_RESPONSE")
    rm -f "$TMP_REQUEST" "$TMP_RESPONSE"

    # Check for success
    if echo "$RESPONSE" | grep -q '"success": *false' || echo "$RESPONSE" | grep -q '"Success": *false'; then
        echo -e "${RED}❌ Push validation failed!${NC}"
        echo ""
        echo "Validation Results:"
        
        # Extract commit count
        COMMITS=$(echo "$RESPONSE" | grep -o '"commits": *[0-9]*' | grep -o '[0-9]*' || echo "unknown")
        echo -e "  Commits to push: ${YELLOW}$COMMITS${NC}"
        
        # Check for check failures
        if echo "$RESPONSE" | grep -q '"checks"'; then
            echo ""
            echo -e "${RED}Static Analysis Issues:${NC}"
            echo "$RESPONSE" | grep -A 10 '"checks"' | head -20
        fi
        
        # Check for test failures
        if echo "$RESPONSE" | grep -q '"tests"'; then
            echo ""
            echo -e "${RED}Test Failures:${NC}"
            echo "$RESPONSE" | grep -A 10 '"tests"' | head -20
        fi
        
        echo ""
        echo -e "${YELLOW}Actions:${NC}"
        echo "  1. Fix the issues listed above"
        echo "  2. Commit your fixes"
        echo "  3. Try pushing again"
        echo ""
        echo -e "${YELLOW}To skip validation (not recommended): git push --no-verify${NC}"
        exit 1
    fi

    # Extract summary info
    COMMITS=$(echo "$RESPONSE" | grep -o '"commits": *[0-9]*' | grep -o '[0-9]*' || echo "0")
    FILES=$(echo "$RESPONSE" | grep -o '"changed_files": *[0-9]*' | grep -o '[0-9]*' || echo "0")

    echo -e "${GREEN}✓ Validation passed${NC}"
    echo "  Commits: $COMMITS"
    echo "  Changed files: $FILES"
    echo ""
done

echo -e "${GREEN}✓ All pre-push checks passed - push allowed${NC}"
exit 0

