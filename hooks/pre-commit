#!/usr/bin/env bash
#
# Git pre-commit hook
# Runs static analysis on staged files
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Find git-guardian-mcp binary
GIT_GUARDIAN=""
if [ -f "$(git rev-parse --show-toplevel)/git-guardian-mcp" ]; then
    GIT_GUARDIAN="$(git rev-parse --show-toplevel)/git-guardian-mcp"
elif command -v git-guardian-mcp &> /dev/null; then
    GIT_GUARDIAN="git-guardian-mcp"
else
    echo -e "${RED}Error: git-guardian-mcp not found${NC}"
    echo "Please build the binary: go build -o git-guardian-mcp"
    exit 1
fi

REPO_PATH=$(git rev-parse --show-toplevel)

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMR)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No staged files to check${NC}"
    exit 0
fi

# Create temporary file for MCP request
TMP_REQUEST=$(mktemp)
TMP_RESPONSE=$(mktemp)

# Convert staged files to absolute paths
FILES_JSON="["
FIRST=true
while IFS= read -r file; do
    if [ ! -f "$REPO_PATH/$file" ]; then
        continue
    fi
    if [ "$FIRST" = true ]; then
        FIRST=false
    else
        FILES_JSON="${FILES_JSON},"
    fi
    FILES_JSON="${FILES_JSON}\"$REPO_PATH/$file\""
done <<< "$STAGED_FILES"
FILES_JSON="${FILES_JSON}]"

# Build MCP request
cat > "$TMP_REQUEST" << EOF
{"jsonrpc":"2.0","id":1,"method":"tools/call","params":{"name":"run_checks","arguments":{"repo_path":"$REPO_PATH","files":$FILES_JSON}}}
EOF

# Call MCP server
if ! "$GIT_GUARDIAN" < "$TMP_REQUEST" > "$TMP_RESPONSE" 2>&1; then
    echo -e "${RED}Failed to run checks${NC}"
    cat "$TMP_RESPONSE"
    rm -f "$TMP_REQUEST" "$TMP_RESPONSE"
    exit 1
fi

# Parse response
RESPONSE=$(cat "$TMP_RESPONSE")
rm -f "$TMP_REQUEST" "$TMP_RESPONSE"

# Extract success status (simple grep-based parsing)
if echo "$RESPONSE" | grep -q '"success": *false' || echo "$RESPONSE" | grep -q '"Success": *false'; then
    echo -e "${RED}Pre-commit checks failed!${NC}"
    echo ""
    echo "Details:"
    echo "$RESPONSE" | grep -E '(Tool|Message|Output|Errors)' || echo "$RESPONSE"
    echo ""
    echo -e "${YELLOW}Tip: Fix the issues above or use 'git commit --no-verify' to skip checks${NC}"
    exit 1
fi

echo -e "${GREEN}âœ“ All pre-commit checks passed${NC}"
exit 0

